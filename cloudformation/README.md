## Using This Template

---

### Overview

This CloudFormation template deploys low overhead infrastucture in AWS to support Metaflow's integration points and extend its capabilities into the Cloud. A brief snapshot of its components are as follows:

- **Amazon S3 Bucket** - Metaflow uses Amazon S3 as a centralized data repository for all data that's leveraged by and generated for its flows. This template creates a dedicated private bucket and all appropriate permissions.

- **AWS Batch Compute Environment** - In order to extend Metaflow's compute capabilities to the cloud, AWS Batch provides a simple API that runs container-based jobs to completion on AWS Elastic Container Service.

- **AWS Step Functions and Event Bridge IAM Resources** - While Step Functions state machines aren't explicitly created by this template, Metaflow's 2.0+ releases include functionality to allow a 1:1 Flow <--> State Machine relationship. In order to facilitate this, there are some IAM roles and policies specific to allowing Metaflow to deploy and trigger Step Functions State Machines.

- **Amazon DynamoDB Table** - Metaflow leverages DynamoDB to store information related to branching paths in flows executed by AWS Step Functions. This template deploys the appropriate table and overlays necessary permissions for AWS Batch and AWS Step Functions to communicate with it.

- **Amazon VPC Networking** - All underlying network components are deployed to facilitate connectivity for the resources leveraged by Metaflow. Specifically, a VPC with (2) customizable subnets and Internet connectivity will be leveraged for this template.

- **AWS Identity and Access Management** - Roles specific to Metaflow will be provisioned by this template in order to provide "principle of least privilege" access to resources such as AWS Batch. Additionally, an optional role can be created that provides restricted access to only the resources Metaflow requires. This allows an easy path of utilization to users who don't need full access to all AWS resources.

### Prerequisites

1. Adequate permissions to deploy all CloudFormation resources within an AWS account.

### How To Deploy from the AWS Console

1. Navigate to "Services" and select "CloudFormation" under the "Management and Governance" heading (or search for it in the search bar).
2. Click "Create stack" and select "With new resources (standard)".
3. Ensure "Template is ready" remains selected, choose "Upload a template file", and click "Choose file".
4. Feel free to explore with "View in Designer" if you so choose, otherwise click "Next".
5. Name your stack, select your parameters, and click "Next", noting that if "CustomRole" is enabled, further configuration will be required after deployment. More info below.
6. If desired, feel free to tag your stack in whatever way best fits your organization. When finished, click "Next".
7. Ensure you select the check box next to "I acknowledge that AWS CloudFormation might create IAM resources." and click "Create stack".
8. Wait roughly 3-5 minutes for deployment to complete. The Stack status will eventually change to "CREATE_COMPLETE".

Once complete, you'll find an "Outputs" tab that contains values for the components generated by this CloudFormation template. Those values correlate to respective environment variables (listed next to the outputs) you'll set to enable cloud features within Metaflow.

### Additional Configuration

- **CustomRole** - This template can create an optional role that can be assumed by users (or applications) that includes limited permissions to only the resources required by Metaflow, including access only to the Amazon S3 bucket and AWS Batch Compute Environment created by this template. You will, however, need to modify the trust policy for the role to grant access to the principals (users/roles/accounts) who will assume it, and you'll also need to have your users configure an appropriate role-assumption profile. The ARN of the Custom Role can be found in the "Output" tab of the CloudFormation stack under `MetaflowUserRoleArn`. To modify the trust policy to allow new principals, follow the directions [here](https://docs.aws.amazon.com/IAM/latest/UserGuide/roles-managingrole-editing-console.html#roles-managingrole_edit-trust-policy). Once you've granted access to the principals of your choice, have your users create a new Profile for the AWS CLI that assumes the role ARN by following the directions [here](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html).
